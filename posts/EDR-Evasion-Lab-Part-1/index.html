<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="EDR Evasion Lab: Part 1" /><meta property="og:locale" content="en_US" /><meta name="description" content="EDR Evasion Lab: Part 1" /><meta property="og:description" content="EDR Evasion Lab: Part 1" /><link rel="canonical" href="https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/" /><meta property="og:url" content="https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/" /><meta property="og:site_name" content="Otterly Offensive" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-08-12T00:00:00-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="EDR Evasion Lab: Part 1" /><meta name="twitter:site" content="@RedTeamOtter" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"mainEntityOfPage":{"@type":"WebPage","@id":"https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/"},"description":"EDR Evasion Lab: Part 1","url":"https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/","@type":"BlogPosting","headline":"EDR Evasion Lab: Part 1","dateModified":"2021-08-12T15:46:56-05:00","datePublished":"2021-08-12T00:00:00-05:00","@context":"https://schema.org"}</script><title>EDR Evasion Lab: Part 1 | Otterly Offensive</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/oo_logo.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/oo_logo.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/oo_logo.jpg"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/oo_logo.jpg"><meta name="apple-mobile-web-app-title" content="Otterly Offensive"><meta name="application-name" content="Otterly Offensive"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/oo_logo.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Otterly Offensive</a></div><div class="site-subtitle font-italic">Otter chaos shall insue</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>EDR Evasion Lab: Part 1</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>EDR Evasion Lab: Part 1</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mr. Otterly </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 12, 2021, 12:00 AM -0500" > Aug 12 <i class="unloaded">2021-08-12T00:00:00-05:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 12, 2021, 3:46 PM -0500" prefix="Updated "> Aug 12 <i class="unloaded">2021-08-12T15:46:56-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1039 words">5 min</span></div></div><div class="post-content"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 540'%3E%3C/svg%3E" data-proofer-ignore data-src="/assets/img/EDR_lab_header.png" class="preview-img" alt="Preview Image" width="1200" height="540"><h1 id="edr-evasion-lab-part-1">EDR Evasion Lab: Part 1</h1><h2 id="genesis">Genesis</h2><p>In January 2021, I finally passed Offensive Security’s OSCE course and exam after a couple of failed attempts for various. While this was super exciting to have tackled this milestone in my personal development, it did leave me wanting more, but I did not know what exactly. Exploit dev was never something that I was really interested in and honestly was scared to tackle for the longest time. While I enjoyed learning the process to be successful in the OSCE exam, I never felt like I would really use the skills in my day job, mostly due to the techniques being very outdated by today’s standards. That being said, it did push me down the path I have chosen to take for 2021 in terms of personal skill development.</p><p>In late April, I started playing around with some dotNet development, as a result of some training that was offered internally where I work. I was not able to sit in on the training but with a little sneaky social engineering, I asked, I was able to get materials from the workshop to look over.</p><p>The workshop was an introductory look at how to create a basic dropper in C# and I am sure the live version had even more good stuff, but I had enough to start picking things apart and building my own droppers as a result.</p><p>Having never really worked with C# it took me awhile to understand what the provided code was doing and more importantly <em>why</em> it was doing what it was. Without any formal programming training or schooling, I have to hack my way through most everything and this was no exception. Within a day or so, I had managed to rework the code in the samples to take advantage of a new C2 channel concept I had worked up the weeks previously. It was crass, but it worked and that was a win for me. Fast-forward a bit and I had leveraged my new-found skills to create several droppers with different capabilities. Not bad for a workshop I didn’t take, right?</p><p>One glaring issue had been staring me in the face the entire time I was starting this development process, and it came time to face it head on. The reality was that my tooling was useless in the real world because it was going to get caught basically every time. Yeah, I could pop calc.exe with no issues but to actually use this tooling in the real world, it was going to get caught…right?</p><p>Sure if I loaded up some meterpreter shellcode as my payload and fired off my dropper, it would get caught right? Well, it depends. With no attempts at obfuscation, most certainly, but with some extra work maybe not.</p><p>How much extra work? Hmmm…</p><p>…and this is where the rabbit hole started.</p><h2 id="the-needful">The Needful</h2><p>Early on in this process I was just testing my work against Windows Defender to see what worked and what didn’t and that is an okay place to start, but I don’t believe that it will take you very far, nor lead to much success. I knew I needed a better proving ground, if you will, to put my work to the test and see what I could learn from it in the process.</p><p>I stated doing cursory research, googling and asking friends their thoughts, on what would some good tools, ideally open source and/or cheap/free (if it’s free, It’s for me!). I was aware of OSSEC and WAZUH already but wanted to know if there were any other good EDR (Endpoint Detection and Response) tools out there. Sadly the friends I asked did not help much, but Google came through for me.</p><p>Google pointed me to a one-hour webcast put on by Black Hills Information Security on May 14th entitled <em><a href="https://youtu.be/yrFnlbwFG_E">Your Free and Open Source EDR Options!</a></em>. BINGO! Great place to start.</p><p><img data-proofer-ignore data-src="/assets/img/google_edr.png" alt="Google Results" /></p><p>In the webcast, there were five different EDR solutions highlighted: OSSEC, WAZUH, Velociraptor, Elastic Endpoint Security (formally Endgame) and Open EDR from Comodo. I knew there had to be some good options, but I honestly did not expect that many.</p><p>While the presenter did a good job of highlighting some benefits and reasons why each solution could be chosen, it did leave me with one question. Which one is the best???</p><p>Now, before we go any further, let me be the first to say that no tool makes one secure. There is no “best” for every situation and any tools or solution’s effectiveness is ultimately up to the people operating and tuning it.</p><p><em>People &gt; Technology</em>.</p><p>I firmly believe that with the right people and processes in place, an organization can secure itself and protect itself extremely well regardless of technology.</p><p>With that being said, I wanted to know which solution was better at detecting and preventing execution of the tooling I was creating.</p><p>So the task was simple — start with out-of-the-box implementation and rule sets of each solution and determine which of them was the toughest to evade.</p><p>The process looks something like this:</p><ul><li>Build out each solution in one of my labs.<li>Document the build outs and publish here — cuz why not?<li>Start with publically available tools to baseline what gets caught out of the gate.<li>Implement various evasion techniques on said public tools, one technique at a time.<li>Start stacking techniques until evasion is possible across all solutions.<li>Then attempt to tune each solution to detect previously successful attempts<li>…<li>…<li>tbd?</ul><p>While I wanted to go all <em>Mythbusters</em> on this and turn this into a fully scientific experiment of sorts, I really do not have the cycles to do this, but I want to do my best to do everything in a controlled manner so that others could replicate what I am doing and have similar results/lessons learned.</p><p>This is going to be a many part series – how many I am not sure of. Five at a minimum but more than likely 10 or so parts, since I want to document the build outs as well as the testing for each EDR solution.</p><p>So stay tuned for next time when <em>Elastic Endpoint Security</em> is first on the chopping block.</p><p><img data-proofer-ignore data-src="/assets/img/elastic_endpoint.png" alt="Elastic Endpoint Security" /></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/edr/'>EDR,</a>, <a href='/categories/evasion/'>Evasion</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/implant/" class="post-tag no-text-decoration" >implant.</a> <a href="/tags/edr/" class="post-tag no-text-decoration" >edr,</a> <a href="/tags/evasion/" class="post-tag no-text-decoration" >evasion,</a> <a href="/tags/redteam/" class="post-tag no-text-decoration" >redteam</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=EDR Evasion Lab: Part 1 - Otterly Offensive&url=https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=EDR Evasion Lab: Part 1 - Otterly Offensive&u=https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=EDR Evasion Lab: Part 1 - Otterly Offensive&url=https://otterlyoffensive.com/posts/EDR-Evasion-Lab-Part-1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/EDR-Evasion-Lab-Part-1/">EDR Evasion Lab: Part 1</a><li><a href="/posts/EAEC2/">Enterprise Attacker Emulation and C2 Implant Development w/ Joff Thyer</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/edr/">edr,</a> <a class="post-tag" href="/tags/evasion/">evasion,</a> <a class="post-tag" href="/tags/implant/">implant.</a> <a class="post-tag" href="/tags/redteam/">redteam</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/EAEC2/"><div class="card-body"> <span class="timeago small" > May 10 <i class="unloaded">2021-05-10T00:00:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enterprise Attacker Emulation and C2 Implant Development w/ Joff Thyer</h3><div class="text-muted small"><p> Enterprise Attacker Emulation and C2 Implant Development w/ Joff Thyer In May 2021, I had the pleasure of sitting in the virtual iteration of Wild West Hacking Fest’s training offering written and...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/EAEC2/" class="btn btn-outline-primary" prompt="Older"><p>Enterprise Attacker Emulation and C2 Implant Development w/ Joff Thyer</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/RedTeamOtter">Mr. Otterly</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/c2/">c2</a> <a class="post-tag" href="/tags/edr/">edr,</a> <a class="post-tag" href="/tags/evasion/">evasion,</a> <a class="post-tag" href="/tags/implant/">implant.</a> <a class="post-tag" href="/tags/redteam/">redteam</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://otterlyoffensive.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script>
